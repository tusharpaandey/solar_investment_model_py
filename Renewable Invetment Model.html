<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renewable Energy Investment Model</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .metric-card {
            transition: all 0.3s ease-in-out;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom scrollbar for cash flow table */
        .cashflow-table-container::-webkit-scrollbar {
            height: 8px;
        }
        .cashflow-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .cashflow-table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .cashflow-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Renewable Energy Investment Model</h1>
            <p class="text-lg text-gray-600 mt-2">Financial Viability Assessment for a 100 MW Solar Project in Rajasthan, India</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Inputs & Assumptions -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">Project Assumptions</h2>
                
                <!-- Project Specs -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Project Specifications</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="capacity" class="text-sm font-medium text-gray-600">Capacity (MW)</label>
                            <input type="number" id="capacity" value="100" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="plf" class="text-sm font-medium text-gray-600">Plant Load Factor (PLF) (%)</label>
                            <input type="number" id="plf" value="21.5" step="0.1" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Financial Assumptions -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Financial Assumptions</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="capex" class="text-sm font-medium text-gray-600">CAPEX (₹ Crore/MW)</label>
                            <input type="number" id="capex" value="4.2" step="0.1" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div>
                            <label for="tariff" class="text-sm font-medium text-gray-600">Tariff (₹/kWh)</label>
                            <input type="number" id="tariff" value="2.60" step="0.01" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="debtEquityRatio" class="text-sm font-medium text-gray-600">Debt/Equity Ratio</label>
                            <div class="flex items-center space-x-2">
                                <span class="font-mono">70</span>
                                <input type="range" id="debtEquityRatio" min="50" max="80" value="70" class="w-full">
                                <span class="font-mono">30</span>
                            </div>
                        </div>
                        <div>
                            <label for="interestRate" class="text-sm font-medium text-gray-600">Interest Rate on Debt (%)</label>
                            <input type="number" id="interestRate" value="8.5" step="0.1" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="discountRate" class="text-sm font-medium text-gray-600">Discount Rate (Equity) (%)</label>
                            <input type="number" id="discountRate" value="12" step="0.1" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>
                
                <button id="calculateBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">Calculate Financials</button>
            </div>

            <!-- Right Column: Outputs & Visuals -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Key Metrics -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="metric-card bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-semibold text-gray-500">NPV</h4>
                        <p id="npv" class="text-2xl font-bold text-green-600">₹0 Cr</p>
                    </div>
                    <div class="metric-card bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-semibold text-gray-500">IRR (Equity)</h4>
                        <p id="irr" class="text-2xl font-bold text-green-600">0%</p>
                    </div>
                    <div class="metric-card bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-semibold text-gray-500">Payback Period</h4>
                        <p id="payback" class="text-2xl font-bold text-blue-600">0 Yrs</p>
                    </div>
                    <div class="metric-card bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h4 class="text-sm font-semibold text-gray-500">LCOE</h4>
                        <p id="lcoe" class="text-2xl font-bold text-blue-600">₹0/kWh</p>
                    </div>
                </div>

                <!-- Monte Carlo Simulation -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Risk Analysis: Monte Carlo Simulation</h2>
                        <button id="runMonteCarlo" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-red-700 transition duration-300 shadow-md">Run Simulation</button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Simulates 1000 scenarios with random variations in CAPEX (±10%) and PLF (±5%) to assess the project's risk profile.</p>
                    <div id="monteCarloLoader" class="hidden text-center py-4">
                        <p>Running simulations...</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                          <div id="monteCarloProgress" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <canvas id="monteCarloChart" height="120"></canvas>
                </div>

                <!-- Cash Flow Projections -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">25-Year Cash Flow Projections (₹ Crore)</h2>
                    <div class="cashflow-table-container overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                                    <!-- Headers will be generated by JS -->
                                </tr>
                            </thead>
                            <tbody id="cashFlowBody" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// --- UTILITY FUNCTIONS ---
const $ = (id) => document.getElementById(id);

// --- CHARTING GLOBALS ---
let monteCarloChartInstance = null;

// --- CORE FINANCIAL LOGIC ---
function calculateFinancials() {
    // 1. GATHER INPUTS
    const capacity = parseFloat($('capacity').value); // MW
    const plf = parseFloat($('plf').value) / 100; // decimal
    const capexPerMW = parseFloat($('capex').value); // Cr/MW
    const tariff = parseFloat($('tariff').value); // Rs/kWh
    const debtEquityRatio = parseFloat($('debtEquityRatio').value) / 100; // decimal
    const interestRate = parseFloat($('interestRate').value) / 100; // decimal
    const discountRate = parseFloat($('discountRate').value) / 100; // decimal

    const projectLife = 25; // years
    const loanTenure = 15; // years
    const depreciationRate = 0.0528; // As per CERC
    const corporateTaxRate = 0.25; // Approximate
    const annualDegradation = 0.007; // 0.7% per year

    // 2. INITIAL CALCULATIONS
    const totalCapex = capacity * capexPerMW; // Cr
    const totalDebt = totalCapex * debtEquityRatio;
    const equityInvested = totalCapex * (1 - debtEquityRatio);

    // 3. GENERATE 25-YEAR CASH FLOW
    let cashFlows = [];
    let cumulativePat = 0;
    let remainingLoan = totalDebt;
    let cumulativeDepreciation = 0;
    
    for (let year = 1; year <= projectLife; year++) {
        const currentDegradation = Math.pow(1 - annualDegradation, year - 1);
        const generation = capacity * plf * 8760 * currentDegradation / 1000; // GWh -> Million kWh
        const revenue = generation * tariff; // Cr

        const opex = totalCapex * 0.01; // 1% of CAPEX

        const ebitda = revenue - opex;

        // Loan Calculation
        const annualInterest = remainingLoan * interestRate;
        const pmt = totalDebt * (interestRate * Math.pow(1 + interestRate, loanTenure)) / (Math.pow(1 + interestRate, loanTenure) - 1);
        const principalRepayment = (year <= loanTenure) ? pmt - annualInterest : 0;
        
        // Depreciation
        const depreciation = totalCapex * depreciationRate;
        cumulativeDepreciation += depreciation;

        const pbt = ebitda - annualInterest - depreciation;
        const tax = (pbt > 0) ? pbt * corporateTaxRate : 0;
        const pat = pbt - tax;
        
        const cashFlowToEquity = pat + depreciation - principalRepayment;
        
        cashFlows.push({
            year,
            revenue: revenue.toFixed(2),
            ebitda: ebitda.toFixed(2),
            interest: annualInterest.toFixed(2),
            depreciation: depreciation.toFixed(2),
            pbt: pbt.toFixed(2),
            tax: tax.toFixed(2),
            pat: pat.toFixed(2),
            principal: principalRepayment.toFixed(2),
            cashFlowToEquity: cashFlowToEquity.toFixed(2)
        });

        if (year <= loanTenure) {
            remainingLoan -= principalRepayment;
        }
        cumulativePat += pat;
    }

    // 4. CALCULATE KEY METRICS
    const equityCashFlows = cashFlows.map(cf => parseFloat(cf.cashFlowToEquity));
    
    // NPV Calculation
    let npv = -equityInvested;
    for (let i = 0; i < projectLife; i++) {
        npv += equityCashFlows[i] / Math.pow(1 + discountRate, i + 1);
    }

    // IRR Calculation (using approximation)
    let irr = calculateIRR([-equityInvested, ...equityCashFlows]);

    // Payback Period Calculation
    let cumulativeCashFlow = -equityInvested;
    let paybackPeriod = 0;
    for (let i = 0; i < projectLife; i++) {
        cumulativeCashFlow += equityCashFlows[i];
        if (cumulativeCashFlow > 0) {
            paybackPeriod = i + 1 - (cumulativeCashFlow / equityCashFlows[i]);
            break;
        }
    }
    
    // LCOE Calculation
    const totalGeneration = cashFlows.reduce((sum, cf, i) => {
        const currentDegradation = Math.pow(1 - annualDegradation, i);
        return sum + (capacity * plf * 8760 * currentDegradation); // kWh
    }, 0);
    
    let totalLifetimeCost = totalCapex * 10_000_000; // to Rs
    for (let i = 0; i < projectLife; i++) {
        totalLifetimeCost += (totalCapex * 0.01 * 10_000_000) / Math.pow(1 + discountRate, i + 1);
    }
    const lcoe = totalLifetimeCost / totalGeneration;

    // 5. UPDATE UI
    updateMetricsUI(npv, irr, paybackPeriod, lcoe);
    updateCashFlowTable(cashFlows);
    
    return { irr, npv, paybackPeriod, lcoe };
}

function calculateIRR(cashflows, guess = 0.1) {
    const maxIterations = 1000;
    const tolerance = 1e-7;

    let x0 = guess;
    for (let i = 0; i < maxIterations; i++) {
        let npv = 0;
        let dnpv = 0;
        for (let t = 0; t < cashflows.length; t++) {
            npv += cashflows[t] / Math.pow(1 + x0, t);
            dnpv -= t * cashflows[t] / Math.pow(1 + x0, t + 1);
        }
        
        if (Math.abs(dnpv) < tolerance) break;

        let x1 = x0 - npv / dnpv;
        if (Math.abs(x1 - x0) < tolerance) return x1;
        x0 = x1;
    }
    return x0; // Return best guess if not converged
}

// --- UI UPDATE FUNCTIONS ---
function updateMetricsUI(npv, irr, payback, lcoe) {
    $('npv').textContent = `₹${npv.toFixed(2)} Cr`;
    $('npv').className = `text-2xl font-bold ${npv > 0 ? 'text-green-600' : 'text-red-600'}`;

    $('irr').textContent = `${(irr * 100).toFixed(2)}%`;
    $('irr').className = `text-2xl font-bold ${irr * 100 > $('discountRate').value ? 'text-green-600' : 'text-red-600'}`;

    $('payback').textContent = `${payback.toFixed(2)} Yrs`;
    $('lcoe').textContent = `₹${lcoe.toFixed(2)}/kWh`;
}

function updateCashFlowTable(cashFlows) {
    const tableHead = $('cashFlowBody').previousElementSibling.querySelector('tr');
    const tableBody = $('cashFlowBody');
    
    // Clear previous table
    tableHead.innerHTML = '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metric</th>';
    tableBody.innerHTML = '';

    // Populate headers (Years)
    for (let i = 1; i <= 25; i++) {
        const th = document.createElement('th');
        th.className = "px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
        th.textContent = `Year ${i}`;
        tableHead.appendChild(th);
    }

    // Populate rows (Metrics)
    const metrics = ['revenue', 'ebitda', 'interest', 'depreciation', 'pbt', 'tax', 'pat', 'principal', 'cashFlowToEquity'];
    const metricNames = {
        revenue: 'Revenue',
        ebitda: 'EBITDA',
        interest: 'Interest',
        depreciation: 'Depreciation',
        pbt: 'PBT',
        tax: 'Tax',
        pat: 'PAT',
        principal: 'Principal Repayment',
        cashFlowToEquity: 'Cash Flow to Equity'
    };

    metrics.forEach(metric => {
        const row = document.createElement('tr');
        const metricHeader = document.createElement('td');
        metricHeader.className = 'px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900';
        metricHeader.textContent = metricNames[metric];
        row.appendChild(metricHeader);

        cashFlows.forEach(cf => {
            const cell = document.createElement('td');
            cell.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-500';
            cell.textContent = cf[metric];
            row.appendChild(cell);
        });
        tableBody.appendChild(row);
    });
}


// --- MONTE CARLO SIMULATION ---
function runMonteCarloSimulation() {
    const numSimulations = 1000;
    const results = [];
    
    const baseCapex = parseFloat($('capex').value);
    const basePlf = parseFloat($('plf').value);

    const loader = $('monteCarloLoader');
    const progress = $('monteCarloProgress');
    loader.style.display = 'block';
    progress.style.width = '0%';

    // Run simulations asynchronously to avoid freezing the UI
    let i = 0;
    function runBatch() {
        const batchSize = 50;
        for (let j = 0; j < batchSize && i < numSimulations; j++, i++) {
            const capexVariation = (Math.random() * 0.2) - 0.1; // -10% to +10%
            const plfVariation = (Math.random() * 0.1) - 0.05; // -5% to +5%

            const simCapex = baseCapex * (1 + capexVariation);
            const simPlf = basePlf * (1 + plfVariation);
            
            // Temporarily set sim values to calculate
            $('capex').value = simCapex.toFixed(2);
            $('plf').value = simPlf.toFixed(2);
            
            const { irr } = calculateFinancials();
            results.push(irr * 100);
        }

        progress.style.width = `${(i / numSimulations) * 100}%`;

        if (i < numSimulations) {
            setTimeout(runBatch, 10);
        } else {
            // Restore original values
            $('capex').value = baseCapex;
            $('plf').value = basePlf;
            calculateFinancials(); // Recalculate with original values to update UI

            loader.style.display = 'none';
            plotMonteCarloResults(results);
        }
    }
    
    runBatch();
}

function plotMonteCarloResults(results) {
    const ctx = $('monteCarloChart').getContext('2d');
    
    if (monteCarloChartInstance) {
        monteCarloChartInstance.destroy();
    }

    const bins = {};
    results.forEach(val => {
        const bin = Math.floor(val);
        bins[bin] = (bins[bin] || 0) + 1;
    });

    const labels = Object.keys(bins).sort((a, b) => a - b);
    const data = labels.map(label => bins[label]);

    monteCarloChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(l => `${l}% - ${parseInt(l)+1}%`),
            datasets: [{
                label: 'Frequency of IRR Outcomes',
                data: data,
                backgroundColor: 'rgba(79, 70, 229, 0.8)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Number of Scenarios' }
                },
                x: {
                    title: { display: true, text: 'Equity IRR (%)' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: (tooltipItems) => {
                            return `IRR Range: ${tooltipItems[0].label}`;
                        },
                        label: (tooltipItem) => {
                            return `Count: ${tooltipItem.raw}`;
                        }
                    }
                }
            }
        }
    });
}

// --- EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
    $('calculateBtn').addEventListener('click', calculateFinancials);
    $('runMonteCarlo').addEventListener('click', runMonteCarloSimulation);
    
    // Initial calculation on load
    calculateFinancials();
});

</script>
</body>
</html>
